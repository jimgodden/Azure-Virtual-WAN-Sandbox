{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vpnGateways_vng_name": {
      "type": "String"
    },
    "virtualWans_vwan_name": {
      "type": "String"
    },
    "virtualHubs_vhub1_name": {
      "type": "String"
    },
    "azureFirewalls_AzFW_name": {
      "type": "String"
    },
    "firewallPolicies_AzFW_Policy_name": {
      "type": "String"
    },
    "virtualNetworks_vnet1_externalid": {
      "type": "String"
    },
    "virtualNetworks_vnet2_externalid": {
      "type": "String"
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Network/firewallPolicies",
      "apiVersion": "2022-09-01",
      "name": "[parameters('firewallPolicies_AzFW_Policy_name')]",
      "location": "eastus2",
      "properties": {
        "sku": {
          "tier": "Basic"
        },
        "threatIntelMode": "Alert"
      }
    },
    {
      "type": "Microsoft.Network/virtualWans",
      "apiVersion": "2022-09-01",
      "name": "[parameters('virtualWans_vwan_name')]",
      "location": "eastus2",
      "properties": {
        "disableVpnEncryption": false,
        "allowBranchToBranchTraffic": true,
        "office365LocalBreakoutCategory": "None",
        "type": "Standard"
      }
    },
    {
      "type": "Microsoft.Network/virtualHubs/hubRouteTables",
      "apiVersion": "2022-09-01",
      "name": "[concat(parameters('virtualHubs_vhub1_name'), '/defaultRouteTable')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]"
      ],
      "properties": {
        "routes": [],
        "labels": [
          "default"
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualHubs/hubRouteTables",
      "apiVersion": "2022-09-01",
      "name": "[concat(parameters('virtualHubs_vhub1_name'), '/noneRouteTable')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]"
      ],
      "properties": {
        "routes": [],
        "labels": [
          "none"
        ]
      }
    },
    {
      "type": "Microsoft.Network/vpnGateways",
      "apiVersion": "2022-09-01",
      "name": "[parameters('vpnGateways_vng_name')]",
      "location": "eastus2",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]"
      ],
      "properties": {
        "connections": [],
        "virtualHub": {
          "id": "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]"
        },
        "bgpSettings": {
          "asn": 65515,
          "peerWeight": 0,
          "bgpPeeringAddresses": [
            {
              "ipconfigurationId": "Instance0",
              "customBgpIpAddresses": []
            },
            {
              "ipconfigurationId": "Instance1",
              "customBgpIpAddresses": []
            }
          ]
        },
        "vpnGatewayScaleUnit": 1,
        "natRules": [],
        "enableBgpRouteTranslationForNat": false,
        "isRoutingPreferenceInternet": false
      }
    },
    {
      "type": "Microsoft.Network/azureFirewalls",
      "apiVersion": "2022-09-01",
      "name": "[parameters('azureFirewalls_AzFW_name')]",
      "location": "eastus2",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]",
        "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicies_AzFW_Policy_name'))]"
      ],
      "zones": [
        "1",
        "2",
        "3"
      ],
      "properties": {
        "sku": {
          "name": "AZFW_Hub",
          "tier": "Basic"
        },
        "additionalProperties": {},
        "virtualHub": {
          "id": "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]"
        },
        "hubIPAddresses": {
          "privateIPAddress": "10.50.64.4",
          "publicIPs": {
            "addresses": [
              {
                "address": "20.65.66.134"
              }
            ],
            "count": 1
          }
        },
        "firewallPolicy": {
          "id": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicies_AzFW_Policy_name'))]"
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualHubs/hubVirtualNetworkConnections",
      "apiVersion": "2022-09-01",
      "name": "[concat(parameters('virtualHubs_vhub1_name'), '/test1')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]",
        "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
      ],
      "properties": {
        "routingConfiguration": {
          "associatedRouteTable": {
            "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
          },
          "propagatedRouteTables": {
            "labels": [
              "default"
            ],
            "ids": [
              {
                "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
              }
            ]
          },
          "vnetRoutes": {
            "staticRoutes": [],
            "staticRoutesConfig": {
              "vnetLocalRouteOverrideCriteria": "Contains"
            }
          }
        },
        "remoteVirtualNetwork": {
          "id": "[parameters('virtualNetworks_vnet1_externalid')]"
        },
        "allowHubToRemoteVnetTransit": true,
        "allowRemoteVnetToUseHubVnetGateways": true,
        "enableInternetSecurity": true
      }
    },
    {
      "type": "Microsoft.Network/virtualHubs/hubVirtualNetworkConnections",
      "apiVersion": "2022-09-01",
      "name": "[concat(parameters('virtualHubs_vhub1_name'), '/test2')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualHubs', parameters('virtualHubs_vhub1_name'))]",
        "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
      ],
      "properties": {
        "routingConfiguration": {
          "associatedRouteTable": {
            "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
          },
          "propagatedRouteTables": {
            "labels": [
              "default"
            ],
            "ids": [
              {
                "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('virtualHubs_vhub1_name'), 'defaultRouteTable')]"
              }
            ]
          },
          "vnetRoutes": {
            "staticRoutes": [],
            "staticRoutesConfig": {
              "vnetLocalRouteOverrideCriteria": "Contains"
            }
          }
        },
        "remoteVirtualNetwork": {
          "id": "[parameters('virtualNetworks_vnet2_externalid')]"
        },
        "allowHubToRemoteVnetTransit": true,
        "allowRemoteVnetToUseHubVnetGateways": true,
        "enableInternetSecurity": true
      }
    },
    {
      "type": "Microsoft.Network/virtualHubs",
      "apiVersion": "2022-09-01",
      "name": "[parameters('virtualHubs_vhub1_name')]",
      "location": "eastus2",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualWans', parameters('virtualWans_vwan_name'))]",
        "[resourceId('Microsoft.Network/vpnGateways', parameters('vpnGateways_vng_name'))]",
        "[resourceId('Microsoft.Network/azureFirewalls', parameters('azureFirewalls_AzFW_name'))]"
      ],
      "properties": {
        "virtualHubRouteTableV2s": [],
        "addressPrefix": "10.50.0.0/16",
        "virtualRouterAsn": 65515,
        "virtualRouterIps": [
          "10.50.32.4",
          "10.50.32.5"
        ],
        "routeTable": {
          "routes": []
        },
        "virtualRouterAutoScaleConfiguration": {
          "minCapacity": 2
        },
        "virtualWan": {
          "id": "[resourceId('Microsoft.Network/virtualWans', parameters('virtualWans_vwan_name'))]"
        },
        "vpnGateway": {
          "id": "[resourceId('Microsoft.Network/vpnGateways', parameters('vpnGateways_vng_name'))]"
        },
        "azureFirewall": {
          "id": "[resourceId('Microsoft.Network/azureFirewalls', parameters('azureFirewalls_AzFW_name'))]"
        },
        "routingState": "Provisioned",
        "allowBranchToBranchTraffic": false,
        "hubRoutingPreference": "VpnGateway"
      }
    }
  ]
}